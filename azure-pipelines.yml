trigger:
  branches:
    include:
      - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  # Nome do App Service criado no Azure
  appServiceName: 'testappcaio'

stages:
# ================================
#   BACKEND (.NET API)
# ================================
- stage: Backend
  displayName: "Build & Deploy Backend"
  jobs:
  - job: BuildBackend
    displayName: "Build Backend"
    steps:

    - task: DotNetCoreCLI@2
      displayName: Restore
      inputs:
        command: restore
        projects: 'backend/*.csproj'

    - task: DotNetCoreCLI@2
      displayName: Build
      inputs:
        command: build
        projects: 'backend/*.csproj'
        arguments: '--configuration $(buildConfiguration)'

    - task: DotNetCoreCLI@2
      displayName: Publish
      inputs:
        command: publish
        projects: 'backend/*.csproj'
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: true

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'backend'

  - job: DeployBackend
    displayName: "Deploy Backend to Azure App Service"
    dependsOn: BuildBackend
    steps:
    - download: current
      artifact: backend

    - task: AzureWebApp@1
      displayName: Deploy API
      inputs:
        azureSubscription: 'azure-service-connection'
        appName: '$(appServiceName)'
        package: '$(Pipeline.Workspace)/backend/*.zip'

# ================================
#   FRONTEND (React)
# ================================
- stage: Frontend
  displayName: "Build & Deploy Frontend"
  dependsOn: Backend
  jobs:
  - job: BuildFrontend
    displayName: "Build Frontend"
    steps:

    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'
      displayName: "Install Node"

    - script: |
        cd frontend
        npm install
        npm run build
      displayName: "Build React app"

    - task: AzureStaticWebApp@0
      displayName: "Deploy Static Web App"
      inputs:
        app_location: "/frontend"
        output_location: "build"
        azure_static_web_apps_api_token: "$(STATIC_WEB_APP_API_TOKEN)"
